name: CI (Build)

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  ubuntu-build:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v5
      - name: Install GCC toolchain and Ninja (try GCC-15, fall back to GCC-14)
        run: |
          sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test
          sudo apt-get update
          # Try to install GCC 15 first. If it fails, attempt GCC 14. Do not fail the job if both are unavailable.
          if sudo apt-get install -y gcc-15 g++-15; then
            echo "Using gcc-15"
            echo "CC=gcc-15" | tee -a "$GITHUB_ENV"
            echo "CXX=g++-15" | tee -a "$GITHUB_ENV"
          else
            echo "Failed to install GCC 15, attempting GCC 14 (will not fail the job if unavailable)"
            if sudo apt-get install -y gcc-14 g++-14; then
              echo "Using gcc-14"
              echo "CC=gcc-14" | tee -a "$GITHUB_ENV"
              echo "CXX=g++-14" | tee -a "$GITHUB_ENV"
            else
              echo "Failed to install GCC 14 as well; continuing with system default gcc/g++ (job will not fail)" >&2
            fi
          fi
          sudo apt-get install -y ninja-build python3-pip
      - name: Install formatting & linting tools
        run: |
          sudo apt-get install -y clang-format clang-tidy clang
      - name: Install CMake 4.1.2+
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install --upgrade cmake
          cmake --version
      - name: Configure
        run: |
          cmake -S . -B build -G Ninja -DFORCE_FETCH_DEPS=ON -DENABLE_VALIDATION=ON -DREQUIRE_GCC_15=OFF
      - name: Build (Release)
        run: |
          cmake --build build --config Release -- -k 0
      - name: Run tests
        run: |
          ctest --test-dir build --output-on-failure -C Release
      - name: Format check
        run: |
          # Fail if any file would change under clang-format -style=file
          files=$(git ls-files '*.c' '*.cc' '*.cpp' '*.cxx' '*.h' '*.hh' '*.hpp')
          for f in $files; do
            clang-format -style=file "$f" | diff -u "$f" - || (echo "Formatting issues in $f"; exit 1)
          done
      - name: Run clang-tidy
        run: |
          if [ -f build/compile_commands.json ]; then
            find src -name '*.cpp' -o -name '*.c' -o -name '*.cc' | xargs -r clang-tidy -p build || true
          else
            echo "No compile_commands.json found; skipping clang-tidy"
          fi

  windows-build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v5
      - name: Set up MSYS2 with MinGW-w64 (UCRT)
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >-
            mingw-w64-ucrt-x86_64-gcc
            mingw-w64-ucrt-x86_64-ninja
            mingw-w64-ucrt-x86_64-cmake
            mingw-w64-ucrt-x86_64-clang
            mingw-w64-ucrt-x86_64-clang-tools-extra
      - name: Ensure CMake CLI available (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          # Ensure a cmake command is available in the runner environment. Try Chocolatey if not present.
          if (-not (Get-Command cmake -ErrorAction SilentlyContinue)) {
            Write-Output "cmake not found on PATH; attempting to install via Chocolatey"
            # Try installing via Chocolatey; capture the exit code and continue if it fails
            & choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' -y
            if ($LASTEXITCODE -ne 0) {
              Write-Output "Chocolatey cmake install failed (exit code $LASTEXITCODE); continuing without cmake."
            } else {
              Write-Output "Chocolatey cmake installed successfully"
            }
          } else {
            Write-Output "cmake already available"
          }
      - name: Verify / attempt to upgrade GCC (MinGW, try to prefer GCC-15, fall back to whatever is available)
        shell: msys2 {0}
        run: |
          set -e
          echo "Attempting to ensure a modern GCC is available (prefer >=15.2). This step will try to upgrade but will not fail the job if GCC 15 isn't available."
          # Try to update package DB and install/update mingw gcc packages (best-effort)
          if pacman -Sy --noconfirm mingw-w64-ucrt-x86_64-gcc; then
            echo "Installed/updated mingw-w64-ucrt-x86_64-gcc package"
          else
            echo "Could not install/update mingw-w64-ucrt-x86_64-gcc via pacman; continuing with existing g++" >&2
          fi
          ver=$(g++ -dumpversion || echo "0.0")
          echo "Detected g++ version: $ver"
          major=$(echo "$ver" | cut -d. -f1)
          minor=$(echo "$ver" | cut -d. -f2)
          if [ "$major" -gt 15 ] || { [ "$major" -eq 15 ] && [ "$minor" -ge 2 ]; }; then
            echo "GCC $ver meets >=15.2 requirement"
          else
            echo "GCC $ver is older than 15.2. Attempting full toolchain upgrade (best-effort)" >&2
            pacman -Syu --noconfirm mingw-w64-ucrt-x86_64-toolchain || echo "Toolchain install failed or not available; continuing with existing compiler" >&2
            ver2=$(g++ -dumpversion || echo "0.0")
            echo "Post-upgrade g++ version: $ver2"
            ver=$ver2
            major=$(echo "$ver" | cut -d. -f1)
            minor=$(echo "$ver" | cut -d. -f2)
            if [ "$major" -lt 15 ] || { [ "$major" -eq 15 ] && [ "$minor" -lt 2 ]; }; then
              echo "Still using older GCC ($ver). Continuing the job but note tests/build may use an older compiler." >&2
            else
              echo "Now using GCC $ver (>=15.2)"
            fi
          fi
      - name: Configure (MinGW)
        shell: msys2 {0}
        run: |
          cmake -S . -B build -G Ninja -DFORCE_FETCH_DEPS=ON -DENABLE_VALIDATION=ON -DREQUIRE_GCC_15=OFF
      - name: Build (Release)
        shell: msys2 {0}
        run: |
          cmake --build build --config Release -- -k 0
      - name: Run tests (MinGW)
        shell: msys2 {0}
        run: |
          ctest --test-dir build --output-on-failure -C Release
      - name: Format check (MinGW)
        shell: msys2 {0}
        run: |
          files=$(git ls-files '*.c' '*.cc' '*.cpp' '*.cxx' '*.h' '*.hh' '*.hpp')
          for f in $files; do
            clang-format -style=file "$f" | diff -u "$f" - || { echo "Formatting issues in $f"; exit 1; }
          done
      - name: Run clang-tidy (MinGW)
        shell: msys2 {0}
        run: |
          if [ -f build/compile_commands.json ]; then
            find src -name '*.cpp' -o -name '*.c' -o -name '*.cc' | xargs -r clang-tidy -p build || true
          else
            echo "No compile_commands.json found; skipping clang-tidy"
          fi
